#!/bin/bash

source "./config"
source "./common/utility.sh"

prepare() {
  mkdir -p "$MEDIAWIKI_PATH"
  local clone_depth="--depth=${CLONE_DEPTH:-2}"
  if [ "${CLONE_DEPTH:-1}" -eq 0 ]; then
    local clone_depth=""
  fi

  if ! docker run --rm \
    -v "$SCRIPT_PATH/common:/common" \
    -v "$MEDIAWIKI_PATH:/mediawiki" \
    -w /mediawiki \
    -e GIT_CLONE_BASE_URL="$GIT_CLONE_BASE_URL" \
    -e CLONE_DEPTH="${CLONE_DEPTH:-}" \
    -e BRANCH="${BRANCH:-}" \
    -e VERBOSE \
    -e HOST_UID="$(id -u)" \
    bash:5.1.16-alpine3.21 /usr/local/bin/bash -c '
      apk add --no-cache git >/dev/null 2>&1
      adduser -D -u $HOST_UID tempuser 2>/dev/null
      su tempuser -s /usr/local/bin/bash -c "
        source /common/utility.sh
        clone_git_repo \"$GIT_CLONE_BASE_URL/core.git\" . false \"$BRANCH\"
      "
    '; then
    echo "Failed to clone MediaWiki. Exiting."
    exit 1
  fi

  echo -e "" > "$SCRIPT_PATH/common/docker-compose.components.yml"
  echo "$MW_ENV" >.env

  if [[ "${MW_DBTYPE:-}" == "mysql" ]]; then
    if [[ -f "./import-on-fresh-install/mysql.backup.gz" ]]; then
      ./mysql_restore_from_backup "./import-on-fresh-install/mysql.backup.gz"
    fi
  fi
}

if [[ "$0" == "${BASH_SOURCE[0]}" ]]; then
  prepare "$@"
fi