#!/bin/bash

source "./selenium/selenium.sh"
source "./common/utility.sh"

run_selenium_tests() {
  ensure_selenium_ready || exit 1

  local file_path
  file_path=${1:-"tests/selenium/**/specs/**/*.js"}
  if [[ ! "$file_path" = /* ]]; then
    file_path="/var/www/html/w/$file_path"
  fi

  if [ "$(./shellto s node -e "console.log(require('glob').sync('$file_path').length)")" = "0" ]; then
    echo "No Selenium files found for pattern: '$file_path', skipping..."
    exit 0
  fi

  local test_name
  test_name=${2:-".*"}
  local log_level
  log_level=${3:-"error"}
  # logLevel can be one of these: ( trace | debug | info | warn | error | silent ) https://webdriver.io/docs/configurationfile/

  local retries
  retries=${SELENIUM_RETRIES:-0}
  local instances
  instances=${SELENIUM_INSTANCES:-1}

  ./shellto \
    $([[ "${SILENT:-0}" == "1" ]] || echo "-it") \
    -e DISPLAY=mediawiki-novnc-1:0 \
    -e NODE_PATH=/var/www/html/w/node_modules \
    s npx wdio "/var/local/wdio.conf.override.js" \
      --spec "$file_path" \
      --logLevel "$log_level" \
      --mochaOpts.grep "$test_name" \
      --specFileRetries "$retries" \
      --maxInstances "$instances"
}

if [[ "$0" == "${BASH_SOURCE[0]}" ]]; then
  run_selenium_tests "$@"
fi