#!/bin/bash

source "./selenium/selenium.sh"
source "./common/utility.sh"

run_selenium_tests() {
  ensure_selenium_ready || exit 1

  local component_path=""
  # Only use first arg as component path if it doesn't start with --
  if [[ $# -gt 0 && ! "$1" =~ ^-- ]]; then
    component_path="$1"
  fi

  if [[ -n "$component_path" ]]; then
    if [[ ! "$component_path" =~ ^(extensions|skins)/ ]]; then
      echo "Error: Component path must start with 'extensions/' or 'skins/'"
      exit 1
    fi
    if [[ ! -d "mediawiki/${component_path}" ]]; then
      echo
      echo "Error: Component '${component_path}' is not installed."
      echo -e "Install it first with: \033[32m./install ${component_path}\033[0m"
      echo
      exit 1
    fi
  fi

  ./shellto \
    $([[ "${SILENT:-0}" == "1" ]] || echo "-it") \
    -e NODE_OPTIONS="--require /var/local/wdio-arg-injector.js" \
    -e WDIO_INJECTION_ARGS="$(printf '%s\0' "$@" | base64 -w0)" \
    -w "/var/www/html/w/${component_path}" \
    s bash -c '
      trap "kill 0" INT
      [ -f /var/www/html/w/.env ] && source /var/www/html/w/.env
      export CHROME_PATH
      timeout_after_seconds=900
      timeout --kill-after=30 $timeout_after_seconds npm run selenium-test
      status=$?
      if [ $status -eq 124 ]; then
        echo "Error: selenium-test timed out after $timeout_after_seconds seconds"
      fi
      exit $status
    '
}

if [[ "$0" == "${BASH_SOURCE[0]}" ]]; then
  run_selenium_tests "$@"
fi
