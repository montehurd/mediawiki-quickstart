#cloud-config

apt:
  sources:
    docker.list:
      source: deb [arch=amd64] https://download.docker.com/linux/debian bookworm stable
      keyid: 7EA0A9C3F273FCD8

packages:
  - docker-ce
  - docker-ce-cli
  - containerd.io
  - docker-buildx-plugin
  - docker-compose-plugin

users:
  - name: quickstart
    groups: [sudo, docker]
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL

runcmd:
  # Format and mount the attached volume FIRST, before Docker starts
  - |
    # Find the data volume by its OpenStack volume ID (works with any by-id prefix)
    DATA_VOLUME_ID="${data_volume_id}"

    # Wait for the volume to appear
    RETRIES=30
    DEVICE=""
    while [ $RETRIES -gt 0 ]; do
      DEVICE=$(ls /dev/disk/by-id/*"$DATA_VOLUME_ID"* 2>/dev/null | head -n1)
      if [ -n "$DEVICE" ] && [ -b "$DEVICE" ]; then
        echo "Found data volume: $DEVICE"
        break
      fi
      echo "Waiting for volume with ID $DATA_VOLUME_ID... ($RETRIES retries left)"
      sleep 2
      RETRIES=$((RETRIES - 1))
    done

    if [ -z "$DEVICE" ] || [ ! -b "$DEVICE" ]; then
      echo "ERROR: Volume with ID $DATA_VOLUME_ID not found"
      ls -l /dev/disk/by-id/
      exit 1
    fi

    # Format only if no filesystem exists
    if ! blkid "$DEVICE" >/dev/null 2>&1; then
      echo "No filesystem on $DEVICE, creating ext4..."
      mkfs.ext4 "$DEVICE"
    else
      echo "Filesystem already present on $DEVICE, not reformatting."
    fi

    mkdir -p /mnt/data

    # Mount using the stable path
    if ! mountpoint -q /mnt/data; then
      echo "Mounting $DEVICE on /mnt/data"
      mount "$DEVICE" /mnt/data
    else
      echo "/mnt/data already mounted"
    fi

    # Add to fstab for persistence using the volume ID
    if ! grep -q "$DATA_VOLUME_ID" /etc/fstab; then
      echo "$DEVICE /mnt/data ext4 defaults,nofail 0 2" >> /etc/fstab
    fi

    # Create directories for Docker, containerd, and quickstart project
    mkdir -p /mnt/data/docker /mnt/data/containerd /mnt/data/quickstart
    chown -R quickstart:quickstart /mnt/data/quickstart
  - mkdir -p /mnt/data/selenium-results
  - chown -R quickstart:quickstart /mnt/data/selenium-results
  # Configure Docker MTU to match host interface to prevent SSL/TLS handshake failures
  # Cloud providers (AWS, GCP, Azure) often use MTU values <1500 (e.g., 1450) to accommodate
  # overlay network headers (VXLAN, GRE). Docker defaults to 1500, causing packet fragmentation
  # when containers send large packets. This breaks HTTPS connections, causing timeouts when
  # downloading packages from npm, GitHub, etc. The fix detects the host's MTU and configures
  # Docker to match, ensuring containers can successfully complete SSL handshakes
  - |
    HOST_MTU=$(ip route | grep default | head -n1 | awk '{print $5}' | xargs -I {} ip link show {} | awk -F'mtu ' '{print $2}' | awk '{print $1}')
    mkdir -p /etc/docker
    # Configure Docker with both MTU and data directory
    cat > /etc/docker/daemon.json << DOCKEREOF
    {
      "mtu": $HOST_MTU,
      "data-root": "/mnt/data/docker"
    }
    DOCKEREOF
    # Configure containerd to use data volume
    mkdir -p /etc/containerd
    containerd config default > /etc/containerd/config.toml
    sed -i "s|root = '/var/lib/containerd'|root = '/mnt/data/containerd'|" /etc/containerd/config.toml
    # Restart services to pick up new config
    systemctl restart containerd
    systemctl restart docker
  # Clone to the data volume
  - su quickstart -c "git clone https://gitlab.wikimedia.org/repos/test-platform/mediawiki-quickstart.git /mnt/data/quickstart/mediawiki-quickstart"
  - sleep 5
  - |
    cat > /etc/systemd/system/results-server.service << 'EOL'
    [Unit]
    Description=Vue Server for Selenium Results
    After=selenium-test.service
    [Service]
    Type=simple
    User=quickstart
    WorkingDirectory=/mnt/data/quickstart/mediawiki-quickstart/ci.components
    Environment="RESULTS_PATH=/mnt/data/selenium-results"
    ExecStart=docker compose up
    Restart=always
    [Install]
    WantedBy=multi-user.target
    EOL
  - |
    cat > /etc/systemd/system/selenium-test.service << 'EOL'
    [Unit]
    Description=Continuous Selenium Test Runner
    After=network.target

    [Service]
    Type=simple
    User=quickstart
    WorkingDirectory=/mnt/data/quickstart/mediawiki-quickstart
    Environment="FORCE=1"
    Environment="SKIP_COUNTDOWN=1"
    Environment="SILENT=1"
    Environment="SKIP_LOCALIZATION_CACHE_REBUILD=1"
    Environment="SKIP_PAGE_IMPORT=1"
    Environment="RECLAIM_DISK_SPACE=1"
    Environment="RESULTS_PATH=/mnt/data/selenium-results"
    ExecStart=/bin/bash -c 'sleep 30 && git pull && ./ci.components/run_all && docker compose down && sudo systemctl restart docker && sudo systemctl restart results-server'
    Restart=always

    [Install]
    WantedBy=multi-user.target
    EOL
  - sleep 5
  - systemctl daemon-reload
  - systemctl enable results-server
  - systemctl start results-server
  - systemctl enable selenium-test
  - systemctl start selenium-test
  - |
    mkdir -p /etc/systemd/journald.conf.d
    cat > /etc/systemd/journald.conf.d/size-limit.conf << 'EOL'
    [Journal]
    SystemMaxUse=200M
    SystemMaxFileSize=20M
    EOL
  - systemctl restart systemd-journald
  - journalctl --vacuum-size=200M
  - apt-get clean

package_update: true
package_upgrade: true

final_message: "The system is finally up, after $UPTIME seconds"
