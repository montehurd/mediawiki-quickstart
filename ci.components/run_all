#!/bin/bash
set -euo pipefail

source "./ci.components/run_for_component"
source "./ci.components/run_for_core"
RUSULTS_DIR="${RUSULTS_DIR:-./ci.components/results}"

separator="-----------------------------------------------------------------"

list_all_components() {
  find extensions skins -mindepth 1 -maxdepth 1 -type d | sort
}

component_slug() {
  local s="${1#./}"
  s="${s%/}"
  s="${s// /-}"
  s="${s//\//-}"
  printf '%s' "$s"
}
run_all() {
  local ts
  ts="$(date -u +%s)"

  local run_dir="${RUSULTS_DIR}/${ts}"
  local results_dir="${run_dir}/results"
  mkdir -p "${results_dir}"

  local aggregate_log="${run_dir}/${ts}.logs.ansi"
  local yaml_file="${run_dir}/${ts}.yaml"
  # Open aggregate log
  exec 3>"${aggregate_log}"

  # YAML header
  local yaml_content="timestamp: ${ts}
commit:
  hash: $(git rev-parse --short HEAD)
  message: $(git log -1 --format='%s')"

  # ----- Core -----
  local core_dir="${results_dir}/core"
  mkdir -p "${core_dir}"
  local core_log="${core_dir}/logs.ansi"

  # Run duplicated to both aggregate and core logs

  local core_results
  core_results="$(run_for_core 3> >(tee -a "${aggregate_log}" >"${core_log}"))"

  yaml_content+="core:${core_results}components:"

  # HTML for core
  if command -v alpine_ansi2html &>/dev/null; then
    alpine_ansi2html <"${core_log}" >"${core_log}.html"
  fi

  # Components
  local component
  for component in $(list_all_components); do
    local slug comp_dir comp_log comp_yaml
    slug="$(component_slug "${component}")"
    comp_dir="${results_dir}/${slug}"
    mkdir -p "${comp_dir}"
    comp_log="${comp_dir}/logs.ansi"

    comp_yaml="$(run_for_component "${component}" 3> >(tee -a "${aggregate_log}" >"${comp_log}"))"
    yaml_content+="${comp_yaml}"

    if command -v alpine_ansi2html &>/dev/null; then
      alpine_ansi2html <"${comp_log}" >"${comp_log}.html"
    fi
  done

  # Close aggregate
  exec 3>&-

  # Save YAML
  printf '%s\n' "${yaml_content}" >"${yaml_file}"

  # Aggregate HTML
  if command -v alpine_ansi2html &>/dev/null; then
    alpine_ansi2html <"${aggregate_log}" >"${aggregate_log}.html"
  fi

  printf 'Run complete: %s\n' "${run_dir}"
}

if [[ "$0" == "${BASH_SOURCE[0]}" ]]; then
  run_all "$@"
fi
