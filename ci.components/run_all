#!/bin/bash
set -euo pipefail

RESULTS_PATH="${RESULTS_PATH:-./ci.components/results}"
source "./ci.components/run_for_component"
source "./ci.components/run_for_core"

separator="-----------------------------------------------------------------"

ansi2html() {
  docker exec -i ansi2html ansi2html
}

list_all_components() {
  find extensions skins -mindepth 1 -maxdepth 1 -type d | sort
}

component_slug() {
  local s="${1#./}"
  s="${s%/}"
  s="${s// /-}"
  s="${s//\//-}"
  printf '%s' "$s"
}

# Convert ANSI to HTML
convert_to_html() {
  local ansi_file="$1"
  ansi2html <"${ansi_file}" >"${ansi_file}.html"
}

run_all() {
  local ts
  ts="$(date -u +%s)"

  local run_dir="${RESULTS_PATH}/${ts}"
  mkdir -p "${run_dir}"

  local yaml_file="${run_dir}/run.yaml"

  local yaml_content="timestamp: ${ts}
commit:
  hash: $(git rev-parse --short HEAD)
  message: $(git log -1 --format='%s')"

  # ----- Core -----
  local core_dir="${run_dir}/core"
  mkdir -p "${core_dir}"
  local core_log="${core_dir}/log.ansi"

  local core_results
  core_results="$(run_for_core 3>"${core_log}")"

  convert_to_html "${core_log}"

  yaml_content+=$'\ncore:'"${core_results}"$'\ncomponents:'

  # ----- Components -----
  local component
  for component in $(list_all_components); do
    local comp_type comp_name comp_dir comp_log comp_yaml

    # Extract type (extensions/skins) and name
    comp_type="$(dirname "${component}")"
    comp_name="$(basename "${component}")"

    comp_dir="${run_dir}/${comp_type}/${comp_name}"
    mkdir -p "${comp_dir}"
    comp_log="${comp_dir}/log.ansi"

    comp_yaml="$(run_for_component "${component}" 3>"${comp_log}")"

    convert_to_html "${comp_log}"

    yaml_content+="${comp_yaml}"
  done

  # Save YAML
  printf '%s\n' "${yaml_content}" >"${yaml_file}"
  printf 'Run complete: %s\n' "${run_dir}"
}

if [[ "$0" == "${BASH_SOURCE[0]}" ]]; then
  docker rm -f ansi2html >/dev/null 2>&1 
  docker run --platform linux/amd64 -d --name ansi2html -i --entrypoint cat ghcr.io/montehurd/mediawiki-docker-images/ansi2html:latest >/dev/null
  run_all "$@"
  docker rm -f ansi2html >/dev/null 2>&1 
fi
