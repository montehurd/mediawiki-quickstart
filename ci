#!/bin/bash

root="manifests"

manifests=("extensions" "skins")

manifest_max_length=0
manifest_width=0

reports=()

for manifest in "${manifests[@]}"; do
  folders=$(find "$root/$manifest" -mindepth 1 -maxdepth 1 -type d | sort)

  for folder in $folders; do
    folder_name=$(basename "$folder")
      if [ ${#folder_name} -gt $manifest_max_length ]; then
        manifest_max_length=${#folder_name}
        manifest_width=$(( manifest_max_length + 1 ))
      fi
      report=()

      echo "--------------------------------------------------------------------------------"
      echo "${folder_name}"
      echo "--------------------------------------------------------------------------------"
      report+=("$folder_name")

      echo "--------------------------------------------------------------------------------"
      echo "./fresh_install"
      echo "--------------------------------------------------------------------------------"
      FORCE=1 SILENT=1 SKIP_COUNTDOWN=1 SKIP_SKIN=1 VERBOSE=1 ./fresh_install
      report+=($?)

      echo "--------------------------------------------------------------------------------"
      echo "./install $manifest/$folder_name"
      echo "--------------------------------------------------------------------------------"
      SILENT=1 VERBOSE=1 ./install "$manifest/$folder_name"
      report+=($?)

      echo "--------------------------------------------------------------------------------"
      echo "./run_selenium_tests $manifest/$folder_name"
      echo "--------------------------------------------------------------------------------"
      if grep -q '"selenium-test"' "./mediawiki/$manifest/$folder_name/package.json"; then
        SILENT=1 VERBOSE=1 ./run_selenium_tests "$manifest/$folder_name/tests/selenium/*specs/**/*.js" ".*"
        report+=($?)
      else
          report+=("n/a")
      fi
      reports+=("${report[*]}")

      echo "--------------------------------------------------------------------------------"
      printf "%-${manifest_width}s%-14s%-8s%-20s\n" "Manifest" "fresh_install" "install" "run_selenium_tests"
      echo "--------------------------------------------------------------------------------"
      for report in "${reports[@]}"; do
          printf "%-${manifest_width}s%-14s%-8s%-20s\n" $report
      done
      echo "--------------------------------------------------------------------------------"
  done
done
